<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sunnahway Stories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
        }

        .story-card {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .preview-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
            min-height: 60px;
        }

        .preview-box strong,
        .story-card strong,
        strong {
            color: #0d6efd;
            font-weight: 700 !important;
        }

        .story-card p {
            line-height: 1.6;
        }

        .rich-editor {
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.75rem;
            line-height: 1.6;
        }

        .rich-editor:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .rich-editor strong {
            font-weight: 700;
            color: #0d6efd;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4">ðŸ“š Sunnahway Stories - Admin Panel</h1>

        <div class="row">
            <div class="col-md-3">
                <h5>Categories</h5>
                <div id="categoryList"></div>
            </div>

            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="categoryTitle">Select a category</h5>
                    <button class="btn btn-primary" onclick="showAddModal()" id="addBtn" style="display:none">+ Add
                        Story</button>
                </div>
                <div id="storiesList"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="storyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Story</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Story ID (English, lowercase)</label>
                        <input type="text" class="form-control" id="storyId" placeholder="e.g. prophet_adam">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="storyTitle">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Summary <small class="text-muted">(Ctrl+B for bold)</small></label>
                        <div class="form-control rich-editor" id="storySummary" contenteditable="true"
                            style="min-height: 80px;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Paragraphs <small class="text-muted">(Ctrl+B for bold, Enter for new
                                paragraph)</small></label>
                        <div class="form-control rich-editor" id="storyParagraphs" contenteditable="true"
                            style="min-height: 200px;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Moral <small class="text-muted">(Ctrl+B for bold)</small></label>
                        <div class="form-control rich-editor" id="storyMoral" contenteditable="true"
                            style="min-height: 60px;"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Source</label>
                        <input type="text" class="form-control" id="storySource" placeholder="e.g. Quran 2:30">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStory()">Save & Push to Git</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let categories = [];
        let currentCategory = null;
        let editingId = null;

        // Load categories
        async function loadCategories() {
            const res = await fetch('/api/categories');
            categories = await res.json();
            document.getElementById('categoryList').innerHTML = `
                <div class="list-group">
                    ${categories.map(cat => `
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="loadCategory('${cat.id}', '${cat.title}')">
                            ${cat.title}
                        </a>
                    `).join('')}
                </div>
            `;
        }

        // Load category stories
        async function loadCategory(id, title) {
            currentCategory = id;
            document.getElementById('categoryTitle').textContent = title;
            document.getElementById('addBtn').style.display = 'block';

            const res = await fetch(`/api/stories/${id}`);
            const stories = await res.json();

            document.getElementById('storiesList').innerHTML = stories.map(story => `
                <div class="story-card">
                    <h6>${story.title}</h6>
                    <p class="text-muted small">${formatText(story.summary || '')}</p>
                    <button class="btn btn-sm btn-outline-primary" onclick='editStory(${JSON.stringify(story).replace(/'/g, "&apos;")})'>Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStory('${story.id}')">Delete</button>
                </div>
            `).join('');
        }

        // Format text (convert **text** to bold)
        function formatText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // Show add modal
        function showAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Story';
            document.getElementById('storyId').value = '';
            document.getElementById('storyTitle').value = '';
            document.getElementById('storySummary').innerHTML = '';
            document.getElementById('storyParagraphs').innerHTML = '';
            document.getElementById('storyMoral').innerHTML = '';
            document.getElementById('storySource').value = '';
            new bootstrap.Modal(document.getElementById('storyModal')).show();
        }

        // Edit story
        function editStory(story) {
            editingId = story.id;
            document.getElementById('modalTitle').textContent = 'Edit Story';
            document.getElementById('storyId').value = story.id;
            document.getElementById('storyTitle').value = story.title;

            // Convert markdown to HTML
            document.getElementById('storySummary').innerHTML = markdownToHtml(story.summary || '');
            document.getElementById('storyParagraphs').innerHTML = (story.paragraphs || []).map(p => `<p>${markdownToHtml(p)}</p>`).join('');
            document.getElementById('storyMoral').innerHTML = markdownToHtml(story.moral || '');
            document.getElementById('storySource').value = story.source || '';

            new bootstrap.Modal(document.getElementById('storyModal')).show();
        }

        // Convert markdown to HTML
        function markdownToHtml(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // Convert HTML to markdown
        function htmlToMarkdown(element) {
            let result = '';

            function processNode(node) {
                for (let child of node.childNodes) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        result += child.textContent;
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        const tagName = child.tagName.toLowerCase();

                        if (tagName === 'strong' || tagName === 'b') {
                            result += '**';
                            processNode(child);
                            result += '**';
                        } else if (tagName === 'p' || tagName === 'div') {
                            processNode(child);
                            result += '\n';
                        } else if (tagName === 'br') {
                            result += '\n';
                        } else {
                            processNode(child);
                        }
                    }
                }
            }

            processNode(element);
            return result.trim();
        }

        // Save story
        async function saveStory() {
            const paragraphsDiv = document.getElementById('storyParagraphs');
            const paragraphsText = htmlToMarkdown(paragraphsDiv);

            const story = {
                id: document.getElementById('storyId').value.trim(),
                categoryId: currentCategory,
                title: document.getElementById('storyTitle').value.trim(),
                summary: htmlToMarkdown(document.getElementById('storySummary')),
                paragraphs: paragraphsText.split('\n').filter(p => p.trim()),
                moral: htmlToMarkdown(document.getElementById('storyMoral')),
                source: document.getElementById('storySource').value.trim()
            };

            if (!story.id || !story.title) {
                Swal.fire('Error', 'ID and Title are required', 'error');
                return;
            }

            Swal.fire({ title: 'Saving...', didOpen: () => Swal.showLoading() });

            const res = await fetch(`/api/stories/${currentCategory}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(story)
            });

            if (res.ok) {
                await fetch('/api/push', { method: 'POST' });
                Swal.fire('Success', 'Story saved and pushed to Git!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('storyModal')).hide();
                loadCategory(currentCategory, document.getElementById('categoryTitle').textContent);
            } else {
                Swal.fire('Error', 'Failed to save', 'error');
            }
        }

        // Delete story
        async function deleteStory(id) {
            const result = await Swal.fire({
                title: 'Delete?',
                text: 'This will delete the story and push to Git',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: 'Deleting...', didOpen: () => Swal.showLoading() });

                const res = await fetch(`/api/stories/${currentCategory}/${id}`, { method: 'DELETE' });

                if (res.ok) {
                    await fetch('/api/push', { method: 'POST' });
                    Swal.fire('Deleted', 'Story deleted and pushed to Git', 'success');
                    loadCategory(currentCategory, document.getElementById('categoryTitle').textContent);
                }
            }
        }

        // Update preview
        function updatePreview(textareaId, previewId) {
            const text = document.getElementById(textareaId).value;
            const preview = document.getElementById(previewId);

            if (!text.trim()) {
                preview.innerHTML = '<em class="text-muted">Preview will appear here...</em>';
                return;
            }

            // Convert **text** to <strong>text</strong>
            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            if (textareaId === 'storyParagraphs') {
                const paragraphs = formatted.split('\n').filter(p => p.trim());
                preview.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
            } else {
                preview.innerHTML = formatted;
            }
        }

        // Initialize
        loadCategories();
    </script>
</body>

</html>